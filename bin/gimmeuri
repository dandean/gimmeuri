#!/usr/bin/env node

var program = require('commander');
var fs = require('fs');
var path = require('path');
var mime = require('mime');

// Read in the version of the program so that `gimmeuri -V` works.
var packagePath = path.join(__dirname, '..', 'package.json');
var packageContent = fs.readFileSync(path.join(__dirname, '..', 'package.json'), 'utf8');
var packageVersion = JSON.parse(packageContent).version;

// Tell the program what it's name is, for --help purposes.
program.name = 'gimmeuri';

program
  .version(packageVersion)
  .usage('[options] <file>')
  .parse(process.argv);

// TODO: Option: limit the file size with sane default.
// TODO: Option: check that file is not a directory first.
// TODO: Option: write to file.

var source = program.args[0];
if (!source) {
  console.error('<file> file is required. See `gimmeuri --help`.');
  return;
}

var mimeType = mime.lookup(source);
var encoding = mime.charsets.lookup(source);
var result = 'data:' + mimeType;

if (encoding) result += ';charset=' + encoding;

result += ';base64,';

var ps = require('child_process').spawn('pbcopy');
ps.stdin.write(result);

fs.createReadStream(source, { encoding: 'base64' }).pipe(ps.stdin)
